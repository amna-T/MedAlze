rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    // Users Collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if request.auth.uid == userId;
    }

    // Collection queries for users
    match /users {
      allow list: if isAuthenticated();
    }

    // Patients Collection
    match /patients/{patientId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
    }

    // Collection queries for patients
    match /patients {
      allow list: if isAuthenticated();
    }

    // X-rays Collection
    match /xrays/{xrayId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
    }

    // Collection queries for xrays
    match /xrays {
      allow list: if isAuthenticated() && request.query.isConstrained('patientId');
    }

    // Appointments Collection
    match /appointments/{appointmentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
    }

    // Collection queries for appointments
    match /appointments {
      allow list: if isAuthenticated() && (request.query.isConstrained('patientId') || request.query.isConstrained('assignedDoctorId'));
    }

    // Prescriptions Collection
    match /prescriptions/{prescriptionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
    }

    // Collection queries for prescriptions
    match /prescriptions {
      allow list: if isAuthenticated() && (request.query.isConstrained('doctorId') || request.query.isConstrained('patientId'));
    }

    // Notifications Collection
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
    }

    // Collection queries for notifications
    match /notifications {
      allow list: if isAuthenticated() && request.query.isConstrained('userId');
    }
  }
}