rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for common checks
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    function isAuthAdmin() {
      return request.auth != null && getUserRole(request.auth.uid) == 'admin';
    }

    function isAuthRadiologist() {
      return request.auth != null && getUserRole(request.auth.uid) == 'radiologist';
    }

    function isAuthDoctor() {
      return request.auth != null && getUserRole(request.auth.uid) == 'doctor';
    }

    function isAuthPatient() {
      return request.auth != null && getUserRole(request.auth.uid) == 'patient';
    }

    function isPatientOwner(patientId) {
      return request.auth != null && request.auth.uid == get(/databases/$(database)/documents/patients/$(patientId)).data.userId;
    }

    // Helper function to check if a doctor is assigned to a specific patient
    function isDoctorAssignedToPatient(doctorId, patientId) {
      return doctorId != null && patientId != null && doctorId in get(/databases/$(database)/documents/patients/$(patientId)).data.get('assignedDoctorIds', []);
    }

    // Users collection
    match /users/{userId} {
      allow read: if request.auth != null && (
                         request.auth.uid == userId || // User can read their own profile
                         isAuthAdmin() || // Admin can read all user profiles
                         (isAuthDoctor() && (
                             resource.data.role == 'patient' || // Doctors can read patient profiles
                             resource.data.role == 'doctor' || // Doctors can read other doctor profiles
                             resource.data.role == 'radiologist' // Doctors can read radiologist profiles
                         )) ||
                         (isAuthRadiologist() && (
                             resource.data.role == 'patient' || // Radiologists can read patient profiles
                             resource.data.role == 'doctor' || // Radiologists can read doctor profiles
                             resource.data.role == 'radiologist' // Radiologists can read other radiologist profiles
                         ))
                     );
      allow create: if request.auth != null;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
      allow write: if isAuthAdmin(); // Admin can manage all user profiles
    }

    // Patients collection
    match /patients/{patientID} {
      allow read: if isAuthAdmin() ||
                     isPatientOwner(patientID) ||
                     (isAuthRadiologist() && resource.data.assignedRadiologistId == request.auth.uid) ||
                     (isAuthDoctor() && request.auth.uid in resource.data.get('assignedDoctorIds', [])); // Doctor can read if assigned
      allow create: if isAuthAdmin() || isAuthRadiologist();
      allow update: if isAuthAdmin() ||
                     (isAuthRadiologist() && resource.data.assignedRadiologistId == request.auth.uid) ||
                     (isAuthDoctor() && request.auth.uid in resource.data.get('assignedDoctorIds', [])); // Doctor can update if assigned
      allow delete: if false;
    }

    // X-rays collection
    match /xrays/{xrayID} {
      allow read: if isAuthAdmin() ||
                     isPatientOwner(resource.data.patientId) ||
                     (isAuthRadiologist() && get(/databases/$(database)/documents/patients/$(resource.data.patientId)).data.assignedRadiologistId == request.auth.uid) ||
                     (isAuthDoctor() && isDoctorAssignedToPatient(request.auth.uid, resource.data.patientId)); // Doctor can read if assigned to patient
      allow create: if isAuthRadiologist();
      allow update: if isAuthAdmin() ||
                     (isAuthRadiologist() && get(/databases/$(database)/documents/patients/$(resource.data.patientId)).data.assignedRadiologistId == request.auth.uid) ||
                     (isAuthDoctor() && isDoctorAssignedToPatient(request.auth.uid, resource.data.patientId)); // Doctor can update if assigned to patient
      allow delete: if false;
    }

    // Prescriptions collection
    match /prescriptions/{prescriptionID} {
      allow read: if isAuthAdmin() ||
                     isPatientOwner(resource.data.patientId) ||
                     (isAuthDoctor() && isDoctorAssignedToPatient(request.auth.uid, resource.data.patientId)); // Doctor can read if assigned to patient
      allow create: if isAuthDoctor();
      allow update: if isAuthAdmin() ||
                     (isAuthDoctor() && resource.data.doctorId == request.auth.uid); // Doctor can update only if they wrote it
      allow delete: if false;
    }

    // Notifications collection
    match /notifications/{notificationID} {
      allow read, update: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null;
      allow delete: if false;
    }

    // Appointments collection
    match /appointments/{appointmentID} {
      allow read: if isAuthAdmin() ||
                     isPatientOwner(resource.data.patientId) ||
                     (isAuthRadiologist() && resource.data.assignedRadiologistId == request.auth.uid) ||
                     (isAuthDoctor() && isDoctorAssignedToPatient(request.auth.uid, resource.data.patientId)); // Doctor can read if assigned to patient
      allow create: if isAuthPatient() || isAuthDoctor();
      allow update: if isAuthAdmin() ||
                     (isAuthRadiologist() && resource.data.assignedRadiologistId == request.auth.uid) ||
                     (isAuthDoctor() && isDoctorAssignedToPatient(request.auth.uid, resource.data.patientId)); // Doctor can update if assigned to patient
      allow delete: if false;
    }
  }
}